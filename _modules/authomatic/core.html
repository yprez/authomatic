





<!DOCTYPE html>



<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" prefix="og: http://ogp.me/ns#"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" prefix="og: http://ogp.me/ns#"> <!--<![endif]-->



<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width" />

	<title>authomatic.core | Authomatic</title>
    	<link rel="icon" type="image/x-icon" href="../../_static/img/favicon.ico" />
	
	
	
	<meta property="og:title" content="authomatic.core | Authomatic" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://peterhudec.github.io/authomatic/_modules/authomatic/core.html" />
	<meta property="og:image" content="http://peterhudec.github.io/authomatic/_static/img/authomatic-seo.gif" />
	
	
	<meta property="og:description" content="Simple yet powerful authorization / authentication client library for Python WEB applications." />
	<meta property="og:site_name" content="Authomatic" />
	
	
    
    
	<meta name="description" content="Simple yet powerful authorization / authentication client library for Python WEB applications.">
    
	
	
	
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <link rel="stylesheet" href="../../_static/css/authomatic.css" type="text/css" />
    	
	<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    	<script type="text/javascript" src="../../_static/jquery.js"></script>
    	<script type="text/javascript" src="../../_static/underscore.js"></script>
    	<script type="text/javascript" src="../../_static/doctools.js"></script>
    	<script type="text/javascript" src="../../_static/foundation/js/vendor/custom.modernizr.js"></script>

</head>



<body>
	
	<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=249464911861131";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script><div id="root"><div class="contain-to-grid">
			<nav class="top-bar">
				<ul class="title-area">
					<li class="name">
					  <h1><a href="../../index.html">Authomatic</a></h1>
					</li>
					<li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li>
				</ul>
				 
				<section class="top-bar-section">
					<ul class="left"><li class="divider"></li></ul>
					
						<ul class="">
<li class="has-dropdown toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a><ul class="dropdown ">
<li class="toctree-l2"><a class="reference internal" href="../../reference/config.html">Config</a></li>
<li class="has-dropdown toctree-l2"><a class="reference internal" href="../../reference/adapters.html">Adapters</a><ul class="dropdown ">
<li class="toctree-l3"><a class="reference internal" href="../../reference/adapters.html#available-adapters">Available Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/adapters.html#implementing-an-adapter">Implementing an Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/classes.html">Classes</a></li>
<li class="has-dropdown toctree-l2"><a class="reference internal" href="../../reference/providers.html">Providers</a><ul class="dropdown ">
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#oauth2-providers">OAuth 2.0 Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#oauth1-providers">OAuth 1.0a Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#openid-providers">OpenID Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#google-app-engine-openid-providers">Google App Engine OpenID Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#abstract-classes-for-providers">Abstract Classes for Providers</a></li>
</ul>
</li>
<li class="has-dropdown toctree-l2"><a class="reference internal" href="../../reference/extras.html">Extras</a><ul class="dropdown ">
<li class="toctree-l3"><a class="reference internal" href="../../reference/extras.html#gae-extras">Google App Engine Extras</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/extras.html#interfaces">Interfaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/javascript.html">JavaScript</a></li>
</ul>
</li>
<li class="has-dropdown toctree-l1"><a class="reference internal" href="../../examples/index.html">Tutorials / Examples</a><ul class="dropdown ">
<li class="toctree-l2"><a class="reference internal" href="../../examples/simple.html">Simple Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/credentials.html">Credentials</a></li>
</ul>
</li>
</ul>

					
					<ul class="left">
						
	<li class="divider"></li>

	
		
			<li><a href="../../genindex.html"  title="General Index">index</a></li>
		
		
			<li><a href="../../py-modindex.html"  title="Python Module Index">modules</a></li>
		

	
					</ul>
				</section>
			</nav>
		</div><div id="header">
			<div class="row">
				
		        <div id="logo-container" class="large-6 columns">
		        	
	<div>
		<a href="../../index.html">
		
	    	
	    		<img id="logo" src="../../_static/img/authomatic.svg" />
	    	
		
		</a>
	</div>

		        </div>
		        <div class="large-6 columns">
		            <p id="motto">
						<span>Authomatic</span><br />
is an <em>authorization</em> / <em>authentication</em><br />
client library for Python web applications<br />
inspired by Alex Vaginâ€™s
<a href="http://code.google.com/p/gae-simpleauth/" target="_blank">Simpleauth</a>.<br /> 
In fact, I almost named it <em>Deathsimpleauth</em>,<br /> 
but that name would be too long<br />
for a succinct library.
					</p>
		        </div>
		        
		    </div>
	    </div>
	    
	    <div class="social-buttons">
	    	<ul>
	    		<li>
	    			<div class="fb-like" data-href="http://peterhudec.github.io/authomatic/_modules/authomatic/core.html" data-send="false" data-layout="button_count" data-width="100" data-show-faces="false" data-font="arial"></div>
	    		</li>
	    		<li>
	    			<div class="g-plusone" data-size="medium" data-href="http://peterhudec.github.io/authomatic/_modules/authomatic/core.html"></div>
	    		</li>
	    		<li>
	    			<a href="https://twitter.com/share" class="twitter-share-button" data-via="AuthomaticPy">Tweet</a>
					<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
	    		</li>
	    	</ul>
	    	
	    </div>
		
		
		
		<div class="row">
	</div>
		
		
		<div class="row">
			
			<div id="content" class="large-9 push-3 columns">
				
  <h1>Source code for authomatic.core</h1><div class="highlight"><pre>
<span class="c">#TODO: Add coding line to all modules</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">authomatic.exceptions</span> <span class="kn">import</span> <span class="n">SessionError</span><span class="p">,</span> <span class="n">MiddlewareError</span>
<span class="kn">import</span> <span class="nn">Cookie</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">exceptions</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>

<span class="c"># Taken from anyjson.py</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Try to import from django, should work on Google App Engine.</span>
        <span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span> <span class="k">as</span> <span class="n">json</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c"># Should work for Python2.6 and higher.</span>
        <span class="kn">import</span> <span class="nn">json</span>

<span class="c">#===============================================================================</span>
<span class="c"># Global variables</span>
<span class="c">#===============================================================================</span>

<span class="n">middleware</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">_counter</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">normalize_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces all values that are single-item iterables with the value of its index 0.</span>
<span class="sd">    </span>
<span class="sd">    :param dict dict_:</span>
<span class="sd">        Dictionary to normalize.</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        Normalized dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">items_to_dict</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts list of tuples to dictionary with duplicate keys converted to lists.</span>
<span class="sd">    </span>
<span class="sd">    :param list items:</span>
<span class="sd">        List of tuples.</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        :class:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">normalize_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple counter to be used in the config to generate unique `id` values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">start</span>
        
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>

<span class="n">_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">provider_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple counter to be used in the config to generate unique `id` values.</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        :class:`int`.</span>
<span class="sd">     </span>
<span class="sd">    Use it in the :doc:`config` like this:</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        import authomatic</span>
<span class="sd">        </span>
<span class="sd">        CONFIG = {</span>
<span class="sd">            &#39;facebook&#39;: {</span>
<span class="sd">                 &#39;class_&#39;: authomatic.providers.oauth2.Facebook,</span>
<span class="sd">                 &#39;id&#39;: authomatic.id(), # returns 1</span>
<span class="sd">                 &#39;consumer_key&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;consumer_secret&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;scope&#39;: [&#39;user_about_me&#39;, &#39;email&#39;]</span>
<span class="sd">            },</span>
<span class="sd">            &#39;google&#39;: {</span>
<span class="sd">                 &#39;class_&#39;: &#39;authomatic.providers.oauth2.Google&#39;,</span>
<span class="sd">                 &#39;id&#39;: authomatic.id(), # returns 2</span>
<span class="sd">                 &#39;consumer_key&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;consumer_secret&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;scope&#39;: [&#39;https://www.googleapis.com/auth/userinfo.profile&#39;,</span>
<span class="sd">                           &#39;https://www.googleapis.com/auth/userinfo.email&#39;]</span>
<span class="sd">            },</span>
<span class="sd">            &#39;windows_live&#39;: {</span>
<span class="sd">                 &#39;class_&#39;: &#39;oauth2.WindowsLive&#39;,</span>
<span class="sd">                 &#39;id&#39;: authomatic.id(), # returns 3</span>
<span class="sd">                 &#39;consumer_key&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;consumer_secret&#39;: &#39;##########&#39;,</span>
<span class="sd">                 &#39;scope&#39;: [&#39;wl.basic&#39;, &#39;wl.emails&#39;, &#39;wl.photos&#39;]</span>
<span class="sd">            },</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">_counter</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Escape a URL including any /.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="s">&#39;~&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">json_qs_parser</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses response body from json or query string.</span>
<span class="sd">    </span>
<span class="sd">    :param body: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># try json first</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># then query string</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">import_string</span><span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports an object by string in dotted notation.</span>
<span class="sd">    </span>
<span class="sd">    taken `from webapp2.import_string() &lt;http://webapp-improved.appspot.com/api/webapp2.html#webapp2.import_string&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">import_name</span><span class="p">:</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">import_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">obj</span><span class="p">]),</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ImportStringError</span><span class="p">(</span><span class="s">&#39;Import from string failed for path {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_name</span><span class="p">),</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">resolve_provider_class</span><span class="p">(</span><span class="n">class_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a provider class. </span>
<span class="sd">    </span>
<span class="sd">    :param class_name: :class:`string` or :class:`authomatic.providers.BaseProvider` subclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="c"># prepare path for authomatic.providers package</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">__package__</span><span class="p">,</span> <span class="s">&#39;providers&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="p">])</span>
        
        <span class="c"># try to import class by string from providers module or by fully qualified path</span>
        <span class="k">return</span> <span class="n">import_string</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">import_string</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">class_</span>


<span class="k">def</span> <span class="nf">id_to_name</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">short_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the provider :doc:`config` key based on it&#39;s</span>
<span class="sd">    ``id`` value.</span>
<span class="sd">    </span>
<span class="sd">    :param dict config:</span>
<span class="sd">        :doc:`config`.</span>
<span class="sd">    :param id:</span>
<span class="sd">        Value of the id parameter in the :ref:`config` to search for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">short_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">k</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No provider with id={} found in the config!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">short_name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">call_wsgi</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls a WSGI application.</span>
<span class="sd">    </span>
<span class="sd">    :param app:</span>
<span class="sd">        WSGI application.</span>
<span class="sd">        </span>
<span class="sd">    :param dict environ:</span>
<span class="sd">        The WSGI *environ* dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Placeholder for status, headers and exec_info.</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dummy start_response to retrieve status, headersand  exc_info from the app.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Copy values.</span>
        <span class="n">args</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">]</span>
    
    <span class="c"># Call the WSGI app and pass it our start_response.</span>
    <span class="n">app_iter</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    
    <span class="c"># Unpack values</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="n">args</span>
    
    <span class="k">return</span> <span class="n">app_iter</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span>


<span class="k">class</span> <span class="nc">ReprMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides __repr__() method with output *ClassName(arg1=value, arg2=value)*.</span>
<span class="sd">    </span>
<span class="sd">    Ignored are attributes</span>
<span class="sd">    </span>
<span class="sd">    * which values are considered false.</span>
<span class="sd">    * with leading underscore.</span>
<span class="sd">    * listed in _repr_ignore.</span>
<span class="sd">    </span>
<span class="sd">    Values of attributes listed in _repr_sensitive will be replaced by *###*.</span>
<span class="sd">    Values which repr() string is longer than _repr_lenght_limit will be represented as *ClassName(...)*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c">#: Iterable of attributes to be ignored.</span>
    <span class="n">_repr_ignore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#: Iterable of attributes which value should not be visible.</span>
    <span class="n">_repr_sensitive</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#: `int` Values longer than this will be truncated to *ClassName(...)*.</span>
    <span class="n">_repr_lenght_limit</span> <span class="o">=</span> <span class="mi">20</span>
    
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c"># get class name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        
        <span class="c"># construct keyword arguments</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="c"># ignore attributes with leading underscores and those listed in _repr_ignore</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_ignore</span><span class="p">:</span>
                
                <span class="c"># replace sensitive values</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_sensitive</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s">&#39;###&#39;</span>
                
                <span class="c"># if repr is too long</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_lenght_limit</span><span class="p">:</span>
                    <span class="c"># Truncate to ClassName(...)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s">&#39;{}(...)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;{}={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        
        <span class="n">args</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s">&#39;{}({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<div class="viewcode-block" id="Future"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Future">[docs]</a><span class="k">class</span> <span class="nc">Future</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an activity run in a separate thread.</span>
<span class="sd">    Subclasses :class:`threading.Thread`, adds :attr:`.get_result` method.</span>
<span class="sd">    </span>
<span class="sd">    .. warning:: |async|</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param callable func:</span>
<span class="sd">            The function to be run in separate thread.</span>
<span class="sd">        </span>
<span class="sd">        Calls :data:`func` in separate thread and returns immediately.</span>
<span class="sd">        Accepts arbitrary positional and keyword arguments which will be passed to :data:`func`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">Future</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
    
    
<div class="viewcode-block" id="Future.get_result"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Future.get_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for the wrapped :data:`func` to finish and returns its result.</span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>
<span class="sd">            </span>
<span class="sd">            This will block the flow of controll until the :data:`func` returns.</span>
<span class="sd">        </span>
<span class="sd">        :param timeout:</span>
<span class="sd">            :class:`float` or ``None`` A timeout for the :data:`func` to return in seconds.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            The result of the wrapped :data:`func`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>

</div></div>
<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dictionary-like secure cookie session implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># List of keys which values are not json serializable.</span>
    <span class="n">NOT_JSON_SERIALIZABLE</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_yadis_services__openid_consumer_&#39;</span><span class="p">,</span>
                             <span class="s">&#39;_openid_consumer_last_token&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;authomatic&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str secret:</span>
<span class="sd">            Session secret used to sign the session cookie.</span>
<span class="sd">        :param str name:</span>
<span class="sd">            Session cookie name.</span>
<span class="sd">        :param int max_age:</span>
<span class="sd">            Maximum allowed age of session kookie nonce in seconds.</span>
<span class="sd">        :param bool secure:</span>
<span class="sd">            If ``True`` the session cookie will be saved wit ``Secure`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">max_age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
    
    
    <span class="k">def</span> <span class="nf">create_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the value for ``Set-Cookie`` HTTP header.</span>
<span class="sd">        </span>
<span class="sd">        :param bool delete:</span>
<span class="sd">            If ``True`` the cookie value will be ``deleted`` and the</span>
<span class="sd">            Expires value will be ``Thu, 01-Jan-1970 00:00:01 GMT``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;{name}={value}; Domain={domain}; Path={path}; HttpOnly{secure}{expires}&#39;</span>
        
        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;deleted&#39;</span> <span class="k">if</span> <span class="n">delete</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">domain</span><span class="o">=</span><span class="n">middleware</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                               <span class="n">path</span><span class="o">=</span><span class="n">middleware</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                               <span class="n">secure</span><span class="o">=</span><span class="s">&#39;; Secure&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">expires</span><span class="o">=</span><span class="s">&#39;; Expires=Thu, 01-Jan-1970 00:00:01 GMT&#39;</span> <span class="k">if</span> <span class="n">delete</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the session cookie to headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c"># Set the cookie header.</span>
        <span class="n">middleware</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cookie</span><span class="p">())</span>
        
        <span class="c"># Reset data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
    
    
    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the session data from cookie.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">morsel</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">(</span><span class="n">middleware</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_COOKIE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">morsel</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deserialize</span><span class="p">(</span><span class="n">morsel</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets session data lazily.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        
    
    <span class="k">def</span> <span class="nf">_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates signature for the session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
        <span class="n">signature</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">signature</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    
    
    <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the value to a signed string with timestamp.</span>
<span class="sd">        </span>
<span class="sd">        TODO: Check licence!</span>
<span class="sd">        Taken from `webapp2_extras.securecookie &lt;http://webapp-improved.appspot.com/guide/extras.html&gt;`_.</span>
<span class="sd">        </span>
<span class="sd">        :param value:</span>
<span class="sd">            Object to be serialized.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            Serialized value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="c"># 1. Handle non json serializable objects.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOT_JSON_SERIALIZABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
        
        <span class="c"># 2. Serialize</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c"># 3. Encode</span>
        <span class="c"># Percent encoding produces smaller result then urlsafe base64.</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c"># Create timestamp</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        
        <span class="c"># Create signature</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        
        <span class="c"># 4. Concatenate</span>
        <span class="k">return</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">encoded</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">signature</span><span class="p">])</span>
    
    
    <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserializes and verifies the value created by :meth:`._serialize`.</span>
<span class="sd">        </span>
<span class="sd">        :param str value:</span>
<span class="sd">            The serialized value.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            Desrialized object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c"># 4. Split</span>
        <span class="n">encoded</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>
        
        <span class="c"># Verify signature</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SessionError</span><span class="p">(</span><span class="s">&#39;Invalid signature &quot;{}&quot;!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signature</span><span class="p">))</span>
        
        <span class="c"># Verify timestamp</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="c"># 3. Decode</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        
        <span class="c"># 2. Deserialize</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        
        <span class="c"># 1. Unpicke non json serializable objects.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOT_JSON_SERIALIZABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">deserialized</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">deserialized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">deserialized</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">deserialized</span>
    
    
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Middleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WSGI middleware responsible for these task during the **login procedure**:</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        * Introspection of current request.</span>
<span class="sd">        * Response creation.</span>
<span class="sd">        * Session management.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">session_max_age</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">secure_cookie</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session_save_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">logging_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;authomatic&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param app:</span>
<span class="sd">            WSGI application that should be wrapped.</span>
<span class="sd">            </span>
<span class="sd">        :param dict config:</span>
<span class="sd">            :doc:`config`</span>
<span class="sd">            </span>
<span class="sd">        :param str secret:</span>
<span class="sd">            A secret string that will be used as the key for signing :class:`.Session` cookie and</span>
<span class="sd">            as a salt by *CSRF* token generation.</span>
<span class="sd">            </span>
<span class="sd">        :param session_max_age:</span>
<span class="sd">            Maximum allowed age of :class:`.Session` kookie nonce in seconds.</span>
<span class="sd">            </span>
<span class="sd">        :param bool secure_cookie:</span>
<span class="sd">            If ``True`` the :class:`.Session` cookie will be saved wit ``Secure`` attribute.</span>
<span class="sd">        </span>
<span class="sd">        :param session:</span>
<span class="sd">            Custom dictionary-like session implementation.</span>
<span class="sd">        </span>
<span class="sd">        :param callable session_save_method:</span>
<span class="sd">            A method of the supplied session or any mechanism that saves the session data and cookie.</span>
<span class="sd">        </span>
<span class="sd">        :param bool report_errors:</span>
<span class="sd">            If ``True`` exceptions encountered during the **login procedure**</span>
<span class="sd">            will be caught and reported in the :attr:`.LoginResult.error` attribute.</span>
<span class="sd">            Default is ``True``.</span>
<span class="sd">        </span>
<span class="sd">        :param bool debug:</span>
<span class="sd">            If ``True`` traceback of exceptions will be written to response.</span>
<span class="sd">            Default is ``False``.</span>
<span class="sd">            </span>
<span class="sd">        :param int logging_level:</span>
<span class="sd">            The logging level treshold as specified in the standard Python</span>
<span class="sd">            `logging library &lt;http://docs.python.org/2/library/logging.html&gt;`_.</span>
<span class="sd">            Default is ``logging.INFO``</span>
<span class="sd">        </span>
<span class="sd">        :param str prefix:</span>
<span class="sd">            Prefix used as the :class:`.Session` cookie name and</span>
<span class="sd">            by which all logs will be prefixed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c"># Set global settings.</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">report_errors</span> <span class="o">=</span> <span class="n">report_errors</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">secure_cookie</span> <span class="o">=</span> <span class="n">secure_cookie</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">session_max_age</span> <span class="o">=</span> <span class="n">session_max_age</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">session_save_method</span><span class="p">)</span>
        
        
        <span class="c"># Set logging level.</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging_level</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The WSGI mechanism.</span>
<span class="sd">        </span>
<span class="sd">        :param environ:</span>
<span class="sd">        :param start_response:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">global</span> <span class="n">config</span>
        
        <span class="c"># Set request specific properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_HOST&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c"># Call the wrapped WSGI app and store it&#39;s output for later.</span>
        <span class="n">app_output</span><span class="p">,</span> <span class="n">app_status</span><span class="p">,</span> <span class="n">app_headers</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="n">call_wsgi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
            <span class="c"># This middleware intercepts only if the login procedure is pending.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">Session</span><span class="p">):</span>
                <span class="c"># We must use the &quot;Set-Cookie&quot; header of the wrapped app</span>
                <span class="c"># if custom session was specified.</span>
                <span class="n">cookie_value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">app_headers</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">session_header</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="n">cookie_value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_header</span><span class="p">)</span>
            
            <span class="n">start_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If login procedure has finished.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">Session</span><span class="p">):</span>
                <span class="c"># If default session is used, delete our session cookie.</span>
                <span class="n">app_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">create_cookie</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
            
            <span class="c"># Write out the output of the wrapped WSGI app.</span>
            <span class="n">start_response</span><span class="p">(</span><span class="n">app_status</span><span class="p">,</span> <span class="n">app_headers</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            
            <span class="k">return</span> <span class="n">app_output</span>
    
    
    <span class="k">def</span> <span class="nf">set_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">session_save_method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows for a custom dictionary-like session to be used.</span>
<span class="sd">        The session must implement the :class:`.extras.interfaces.BaseSession` interface.</span>
<span class="sd">        </span>
<span class="sd">        :param dict session:</span>
<span class="sd">            A dictionary-like session instance.</span>
<span class="sd">            </span>
<span class="sd">        :param callable session_save_method:</span>
<span class="sd">            A callable that saves the session data and sets the session cookie to response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Use default session.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
                                   <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">session_max_age</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                                   <span class="n">secure</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">secure_cookie</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">save_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">save</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Use custom session.</span>
            <span class="k">if</span> <span class="n">session_save_method</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MiddlewareError</span><span class="p">(</span><span class="s">&#39;If you want to use custom &quot;session&quot;, you must also &#39;</span> <span class="o">+</span> \
                                      <span class="s">&#39;specify with the &quot;session_save_method&quot; argument!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_session</span> <span class="o">=</span> <span class="n">session_save_method</span>
        
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The HTTP request body.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">body</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    
    
    <span class="k">def</span> <span class="nf">_clean_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts all single-item values to its index [0] value.</span>
<span class="sd">        </span>
<span class="sd">        :param list items:</span>
<span class="sd">            List of tuples.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">}</span>
    
    
    <span class="k">def</span> <span class="nf">_parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses query string and returns cleaned dictionary.</span>
<span class="sd">        </span>
<span class="sd">        :param str qs:</span>
<span class="sd">            Query string.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">qs</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_dict</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns parsed POST parameters.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span>
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns parsed GET parameters.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span>
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns combined GET and POST parameters.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c"># Normalize common values of GET and POST to one key with list value.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">:</span>
                <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">vp</span> <span class="o">=</span> <span class="n">vp</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">vp</span><span class="p">]</span>
                <span class="n">vg</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>                
                <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vg</span> <span class="o">+</span> <span class="n">vp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">res</span>
    
    
    <span class="k">def</span> <span class="nf">set_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a HTTP response header.</span>
<span class="sd">        </span>
<span class="sd">        :param str key:</span>
<span class="sd">            The name of the header.</span>
<span class="sd">        </span>
<span class="sd">        :param str value:</span>
<span class="sd">            The header value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    
    
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the value to HTTP response</span>
<span class="sd">        </span>
<span class="sd">        :param str value:</span>
<span class="sd">            The string to be written to response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a ``302 Found`` redirect to specified location.</span>
<span class="sd">        </span>
<span class="sd">        :param str location:</span>
<span class="sd">            The URL to redirect to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;302 Found&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.User">[docs]</a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">ReprMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides unified interface to selected **user** informations returned by different **providers**.</span>
<span class="sd">    </span>
<span class="sd">    .. note:: The format of property values may vary across providers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c">#: A :doc:`provider &lt;providers&gt;` instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        
        <span class="c">#: An :class:`.Credentials` instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;credentials&#39;</span><span class="p">)</span>
        
        <span class="c">#: A :class:`dict` containing all the **user** information returned by the **provider**.</span>
        <span class="c">#: The structure differs across **providers**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_user_info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;raw_user_info&#39;</span><span class="p">)</span>
        
        <span class="c">#: :class:`str` ID assigned to the **user** by the **provider**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` User name e.g. *andrewpipkin*.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Name e.g. *Andrew Pipkin*.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` First name e.g. *Andrew*.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;first_name&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Last name e.g. *Pipkin*.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_name&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Nickname e.g. *Andy*.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nickname&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Link URL.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;link&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Gender.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gender&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Timezone.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;timezone&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Locale.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;locale&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` E-mail.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Picture URL.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">picture</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;picture&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`datetime.datetime()` birth date .</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">birth_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;birth_date&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Country.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;country&#39;</span><span class="p">)</span>
        <span class="c">#: :class:`str` Postal code.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;postal_code&#39;</span><span class="p">)</span>
        <span class="c">#: Instance of the Google App Engine Users API</span>
        <span class="c">#: `User &lt;https://developers.google.com/appengine/docs/python/users/userclass&gt;`_ class.</span>
        <span class="c">#: Only present when using the :class:`authomatic.providers.gaeopenid.GAEOpenID` provider.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gae_user</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gae_user&#39;</span><span class="p">)</span>
    
    
<div class="viewcode-block" id="User.update"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.User.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the user info by fetching the **provider&#39;s** user info URL.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            Updated instance of this class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">update_user</span><span class="p">()</span>
    
    </div>
<div class="viewcode-block" id="User.async_update"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.User.async_update">[docs]</a>    <span class="k">def</span> <span class="nf">async_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`.update` but runs asynchronously in a separate thread.</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: |async|</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`.Future` instance representing the separate thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Credentials"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials">[docs]</a><span class="k">class</span> <span class="nc">Credentials</span><span class="p">(</span><span class="n">ReprMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains all neccessary informations to fetch **user&#39;s protected resources**.&quot;&quot;&quot;</span>
    
    <span class="n">_repr_sensitive</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;token&#39;</span><span class="p">,</span> <span class="s">&#39;refresh_token&#39;</span><span class="p">,</span> <span class="s">&#39;token_secret&#39;</span><span class="p">,</span> <span class="s">&#39;consumer_key&#39;</span><span class="p">,</span> <span class="s">&#39;consumer_secret&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="c">#: :class:`str` User **access_with_credentials token**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;token&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c">#: :class:`str` User **access_with_credentials token**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;refresh_token&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c">#: :class:`str` User **access_with_credentials token secret**.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_secret</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;token_secret&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c">#: :class:`int` Expiration date as UNIX timestamp.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;expiration_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c">#: A :doc:`Provider &lt;providers&gt;` instance**.</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;provider&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">expire_in</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;expire_in&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">provider</span><span class="p">:</span>
            <span class="c">#: :class:`str` Provider name specified in the :doc:`config`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">name</span>
            
            <span class="c">#: :class:`str` Provider type e.g. ``&quot;authomatic.providers.oauth2.OAuth2&quot;``.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_type</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
            
            <span class="c">#: :class:`str` Provider short name specified in the :doc:`config`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>            
            
            <span class="c">#: :class:`class` Provider class.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">__class__</span>
            
            <span class="c">#: :class:`str` Consumer key specified in the :doc:`config`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">consumer_key</span>
            
            <span class="c">#: :class:`str` Consumer secret specified in the :doc:`config`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">consumer_secret</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;provider_name&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;provider_type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;provider_id&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;provider_class&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;consumer_key&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;consumer_secret&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expire_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expire_in</span>
    
    <span class="nd">@expire_in.setter</span>
<div class="viewcode-block" id="Credentials.expire_in"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.expire_in">[docs]</a>    <span class="k">def</span> <span class="nf">expire_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes :attr:`.expiration_time` when the value is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expire_in</span> <span class="o">=</span> <span class="n">value</span>
    
    </div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expiration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expiration_time</span>
    
    <span class="nd">@expiration_time.setter</span>
<div class="viewcode-block" id="Credentials.expiration_time"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.expiration_time">[docs]</a>    <span class="k">def</span> <span class="nf">expiration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expiration_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expire_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expiration_time</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Credentials.expiration_date"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.expiration_date">[docs]</a>    <span class="k">def</span> <span class="nf">expiration_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expiration date as :class:`datetime.datetime` or ``None`` if credentials never expire.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expire_in</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span><span class="p">)</span>
    
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Credentials.valid"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.valid">[docs]</a>    <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``True`` if credentials are valid, ``False`` if expired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    
    </div>
<div class="viewcode-block" id="Credentials.expire_soon"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.expire_soon">[docs]</a>    <span class="k">def</span> <span class="nf">expire_soon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``True`` if credentials expire sooner than specified.</span>
<span class="sd">        </span>
<span class="sd">        :param int seconds:</span>
<span class="sd">            Number of seconds.</span>
<span class="sd">            </span>
<span class="sd">        :returns:</span>
<span class="sd">            ``True`` if credentials expire sooner than specified, else ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiration_time</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    </div>
<div class="viewcode-block" id="Credentials.refresh"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.refresh">[docs]</a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">soon</span><span class="o">=</span><span class="mi">86400</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refreshes the credentials only if the **provider** supports it and</span>
<span class="sd">        if it will expire in less than one day.</span>
<span class="sd">        It does nothing in other cases.</span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>
<span class="sd">        </span>
<span class="sd">            The credentials will be refreshed only if it gives sense</span>
<span class="sd">            i.e. only |oauth2|_ has the notion of credentials *refreshment/extension*.</span>
<span class="sd">            And there are also differences across providers</span>
<span class="sd">            e.g. Google supports refreshment only if there is a ``refresh_token`` in the credentials and</span>
<span class="sd">            that in turn is present only if the ``access_type`` parameter was set to ``offline``</span>
<span class="sd">            in the **user authorisation request**.</span>
<span class="sd">        </span>
<span class="sd">        :param bool force:</span>
<span class="sd">            If ``True`` the credentials will be refreshed even if they won&#39;t expire soon.</span>
<span class="sd">        </span>
<span class="sd">        :param int soon:</span>
<span class="sd">            Number of seconds specifying what means *soon*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span><span class="p">,</span> <span class="s">&#39;refresh_credentials&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">expire_soon</span><span class="p">(</span><span class="n">soon</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_class</span><span class="o">.</span><span class="n">refresh_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Credentials.async_refresh"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.async_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">async_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`.refresh` but runs asynchronously in a separate thread.</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: |async|</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`.Future` instance representing the separate thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Credentials.provider_type_class"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.provider_type_class">[docs]</a>    <span class="k">def</span> <span class="nf">provider_type_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the :doc:`provider &lt;providers&gt;` class specified in the :doc:`config`.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`authomatic.providers.BaseProvider` subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">resolve_provider_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_type</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Credentials.serialize"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the credentials to a percent encoded string to be stored for later use.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`string`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c"># Short_name must be the first item in the tuple by all providers.</span>
        <span class="n">short_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_id</span>
        <span class="c"># It always must be present!</span>
        <span class="k">if</span> <span class="n">short_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="s">&#39;The provider config must have a &quot;id&quot; key set to a unique value to be able to serialize credentials!&#39;</span><span class="p">)</span>
        
        <span class="c"># Get the remaining items for the tuple.</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_type_class</span><span class="p">()</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c"># Put it together.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">short_name</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">rest</span>
        
        <span class="c"># Make sure that all items are strings.</span>
        <span class="n">stringified</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        
        <span class="c"># Concatenate by newline.</span>
        <span class="n">concatenated</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stringified</span><span class="p">)</span>
        
        <span class="c"># Percent encode.</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">concatenated</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    
    </div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Credentials.deserialize"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Credentials.deserialize">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A *class method* which reconstructs credentials created by :meth:`serialize`.</span>
<span class="sd">        You can also passit a :class:`.Credentials` instance.</span>
<span class="sd">        </span>
<span class="sd">        :param dict config:</span>
<span class="sd">            The same :doc:`config` used in the :func:`.login` to get the credentials.</span>
<span class="sd">        :param str credentials:</span>
<span class="sd">            :class:`string` The serialized credentials or :class:`.Credentials` instance.</span>
<span class="sd">        </span>
<span class="sd">        :returns:</span>
<span class="sd">            :class:`.Credentials`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c"># Accept both serialized and normal.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Credentials</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">credentials</span>
        
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
        
        <span class="n">split</span> <span class="o">=</span> <span class="n">decoded</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="c"># We need the short name to move forward.</span>
        <span class="n">short_name</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c"># Get provider config by short name.</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="n">id_to_name</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">short_name</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        
        <span class="c"># Get the provider class.</span>
        <span class="n">ProviderClass</span> <span class="o">=</span> <span class="n">resolve_provider_class</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;class_&#39;</span><span class="p">))</span>
        
        <span class="c"># Deserialization is provider specific.</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="n">ProviderClass</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
        
        <span class="n">deserialized</span><span class="o">.</span><span class="n">provider_name</span> <span class="o">=</span> <span class="n">provider_name</span>
        <span class="n">deserialized</span><span class="o">.</span><span class="n">provider_class</span> <span class="o">=</span> <span class="n">ProviderClass</span>
        
        <span class="k">return</span> <span class="n">deserialized</span>

</div></div>
<div class="viewcode-block" id="LoginResult"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.LoginResult">[docs]</a><span class="k">class</span> <span class="nc">LoginResult</span><span class="p">(</span><span class="n">ReprMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result of the :func:`authomatic.login` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="c">#: A :doc:`provider &lt;providers&gt;` instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        
        <span class="c">#: An instance of the :exc:`authomatic.exceptions.BaseError` subclass.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="nd">@property</span>
<div class="viewcode-block" id="LoginResult.user"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.LoginResult.user">[docs]</a>    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A :class:`.User` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">user</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="LoginResult.pending"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.LoginResult.pending">[docs]</a>    <span class="k">def</span> <span class="nf">pending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``False`` if the *login procedure* has finished, ``True`` if still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">middleware</span><span class="o">.</span><span class="n">pending</span>

</div></div>
<div class="viewcode-block" id="Response"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response">[docs]</a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">ReprMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps :class:`httplib.HTTPResponse` and adds</span>
<span class="sd">    :attr:`.content` and :attr:`.data` attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httplib_response</span><span class="p">,</span> <span class="n">content_parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param httplib_response:</span>
<span class="sd">            The wrapped :class:`httplib.HTTPResponse` instance.</span>
<span class="sd">            </span>
<span class="sd">        :param function content_parser:</span>
<span class="sd">            Callable which accepts :attr:`.content` as argument,</span>
<span class="sd">            parses it and returns the parsed data as :class:`dict`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span> <span class="o">=</span> <span class="n">httplib_response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_parser</span> <span class="o">=</span> <span class="n">content_parser</span> <span class="ow">or</span> <span class="n">json_qs_parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c">#: Same as :attr:`httplib.HTTPResponse.msg`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">httplib_response</span><span class="o">.</span><span class="n">msg</span>        
        <span class="c">#: Same as :attr:`httplib.HTTPResponse.version`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">httplib_response</span><span class="o">.</span><span class="n">version</span>        
        <span class="c">#: Same as :attr:`httplib.HTTPResponse.status`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">httplib_response</span><span class="o">.</span><span class="n">status</span>        
        <span class="c">#: Same as :attr:`httplib.HTTPResponse.reason`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">httplib_response</span><span class="o">.</span><span class="n">reason</span>
    
    
<div class="viewcode-block" id="Response.read"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`httplib.HTTPResponse.read`.</span>
<span class="sd">        </span>
<span class="sd">        :param amt:</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Response.getheader"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.getheader">[docs]</a>    <span class="k">def</span> <span class="nf">getheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`httplib.HTTPResponse.getheader`.</span>
<span class="sd">        </span>
<span class="sd">        :param name:</span>
<span class="sd">        :param default:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Response.fileno"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`httplib.HTTPResponse.fileno`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
    
    </div>
<div class="viewcode-block" id="Response.getheaders"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.getheaders">[docs]</a>    <span class="k">def</span> <span class="nf">getheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as :meth:`httplib.HTTPResponse.getheaders`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span><span class="o">.</span><span class="n">getheaders</span><span class="p">()</span>
    
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Response.content"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.content">[docs]</a>    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The whole response content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httplib_response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span>
    
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Response.data"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.Response.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A :class:`dict` of data parsed from :attr:`.content`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

</div></div>
<div class="viewcode-block" id="UserInfoResponse"><a class="viewcode-back" href="../../reference/classes.html#authomatic.core.UserInfoResponse">[docs]</a><span class="k">class</span> <span class="nc">UserInfoResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inherits from :class:`.Response`, adds  :attr:`.user` attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UserInfoResponse</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c">#: :class:`.User` instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>


<span class="c">#===============================================================================</span>
<span class="c"># Public methods</span>
<span class="c">#===============================================================================</span>

</div>
<span class="k">def</span> <span class="nf">setup_middleware</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates the :class:`.Middleware` and stores it to the</span>
<span class="sd">    :data:`.authomatic.core.middleware` global variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">global</span> <span class="n">middleware</span>
    <span class="n">middleware</span> <span class="o">=</span> <span class="n">Middleware</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">middleware</span>


<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session_save_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Launches a login procedure for specified :doc:`provider &lt;providers&gt;` and returns :class:`.LoginResult`.</span>
<span class="sd">    </span>
<span class="sd">    .. warning::</span>
<span class="sd">        Currently the method gets called twice by all :doc:`providers &lt;providers&gt;`. This may change in future.</span>
<span class="sd">        </span>
<span class="sd">        #. First it returns nothing but redirects the **user** to the **provider**,</span>
<span class="sd">           which redirects him back to the enclosing **request handler**.</span>
<span class="sd">        #. Then it gets called again and it finally returns the :class:`.LoginResult`</span>
<span class="sd">           or calls the function specified in the ``callback`` argument with</span>
<span class="sd">           :class:`.LoginResult` passed as argument.</span>
<span class="sd">    </span>
<span class="sd">    :param str provider_name:</span>
<span class="sd">        Name of the provider as specified in the keys of the :doc:`config`.</span>
<span class="sd">    :param callable callback:</span>
<span class="sd">        If specified the function will call the callback with :class:`.LoginResult`</span>
<span class="sd">        passed as argument and will return nothing.</span>
<span class="sd">    :param bool report_errors:</span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">        </span>
<span class="sd">        Accepts additional keyword arguments that will be passed t :doc:`provider` constructor.</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        :obj:`None` or :class:`.LoginResult`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Handle custom session.</span>
    <span class="n">middleware</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">session_save_method</span><span class="p">)</span>
    
    <span class="c"># Inform middleware that the login procedure started.</span>
    <span class="n">middleware</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="c"># retrieve required settings for current provider and raise exceptions if missing</span>
    <span class="n">provider_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">provider_settings</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="s">&#39;Provider name &quot;{}&quot; not specified!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_name</span><span class="p">))</span>
    
    <span class="c"># Resolve provider class.</span>
    <span class="n">class_</span> <span class="o">=</span> <span class="n">provider_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;class_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">class_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ConfigError</span><span class="p">(</span><span class="s">&#39;The &quot;class_&quot; key not specified in the config for provider {}!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_name</span><span class="p">))</span>
    <span class="n">ProviderClass</span> <span class="o">=</span> <span class="n">resolve_provider_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
    
    <span class="c"># instantiate provider class</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">ProviderClass</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="c"># return login result</span>
    <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserializes credentials.</span>
<span class="sd">    </span>
<span class="sd">    :param credentials:</span>
<span class="sd">        Credentials serialized with :meth:`.Credentials.serialize` or :class:`.Credentials` instance.</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        :class:`.Credentials`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">access</span><span class="p">(</span><span class="n">credentials</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">max_redirects</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">content_parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accesses **protected resource** on behalf of the **user**.</span>
<span class="sd">    </span>
<span class="sd">    :param credentials:</span>
<span class="sd">        The **user&#39;s** :class:`.Credentials`.</span>
<span class="sd">        </span>
<span class="sd">    :param str url:</span>
<span class="sd">        The **protected resource** URL.</span>
<span class="sd">        </span>
<span class="sd">    :param str method:</span>
<span class="sd">        HTTP method of the request.</span>
<span class="sd">        </span>
<span class="sd">    :param dict headers:</span>
<span class="sd">        HTTP headers of the request.</span>
<span class="sd">        </span>
<span class="sd">    :param function content_parser:</span>
<span class="sd">        A function to be used to parse the :attr:`.Response.data` from :attr:`.Response.content`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Deserialize credentials.</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
    
    <span class="c"># Resolve provider class.</span>
    <span class="n">ProviderClass</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">provider_class</span>
    
    <span class="c"># Access resource and return response.</span>
    <span class="k">return</span> <span class="n">ProviderClass</span><span class="o">.</span><span class="n">access_with_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
                                                 <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                                                 <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                 <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                                 <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                                 <span class="n">max_redirects</span><span class="o">=</span><span class="n">max_redirects</span><span class="p">,</span>
                                                 <span class="n">content_parser</span><span class="o">=</span><span class="n">content_parser</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">async_access</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Same as :func:`.access` but runs asynchronously in a separate thread.</span>
<span class="sd">    </span>
<span class="sd">    .. warning:: |async|</span>
<span class="sd">    </span>
<span class="sd">    :returns:</span>
<span class="sd">        :class:`.Future` instance representing the separate thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
</pre></div>

			</div>
			
			
			
			<div id="navigation" class="large-3 pull-9 columns">
				<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/config.html">Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/adapters.html">Adapters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/adapters.html#available-adapters">Available Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/adapters.html#implementing-an-adapter">Implementing an Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/classes.html">Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/providers.html">Providers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#oauth2-providers">OAuth 2.0 Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#oauth1-providers">OAuth 1.0a Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#openid-providers">OpenID Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#google-app-engine-openid-providers">Google App Engine OpenID Providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/providers.html#abstract-classes-for-providers">Abstract Classes for Providers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/extras.html">Extras</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/extras.html#gae-extras">Google App Engine Extras</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/extras.html#interfaces">Interfaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/javascript.html">JavaScript</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Tutorials / Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/simple.html">Simple Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/credentials.html">Credentials</a></li>
</ul>
</li>
</ul>

			</div>
			
		</div>
		
		<div id="root_footer"></div>
	</div><div id="footer"><div id="bottom-nav"><span><a href="../../genindex.html"  title="General Index">index</a></span>
				<span><a href="../../py-modindex.html"  title="Python Module Index">modules</a></span>
				</div><div id="footer-notice">
			    	&copy; Copyright 2012,
			    	
			    		<a href="http://peterhudec.com">Peter Hudec</a>
			    		<a class="google-plus-badge" href="//plus.google.com/117034840853387702598?rel=author" rel="author" style="text-decoration:none;">
						<img src="//ssl.gstatic.com/images/icons/gplus-16.png" alt="Google+"/></a>.
		        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
	    </div></div><script>
		document.write('<script src=' +
		('__proto__' in {} ? '../../_static/foundation/js/vendor/zepto' : 'js/vendor/jquery') +
		'.js><\/script>')
	</script>
	<script src="../../_static/foundation/js/foundation.min.js"></script>
	<script src="../../_static/foundation/js/foundation/foundation.topbar.js"></script>
	<script>
		$(document).foundation();
		
		/**
		 * Fallback svg to png.
		 * Taken from Todd Motto's article:
		 * http://toddmotto.com/mastering-svg-use-for-a-retina-web-fallbacks-with-png-script/
		 */
		if(!Modernizr.svg) {
		    $('img[src*="svg"]').attr('src', function() {
		        return $(this).attr('src').replace('.svg', '.png');
		    });
		}
		
		// Reset width of all table columns.
		$('col').attr('width', null);
		
		// Add "returns" class to all returns elements
		$(".field-name:contains('Returns:')").parent().addClass('returns');
		
		
		(function() {
		    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		    po.src = 'https://apis.google.com/js/plusone.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
		})();
		
		
		
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-40554445-4']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
		
	</script>
	
		<a id="github-ribbon" href="https://github.com/peterhudec/authomatic">
			<img style="position: absolute; top: 0; right: 0; border: 0;"
				 src="../../_static/img/github-ribbon-right.png"
				 alt="Fork me on GitHub">
		</a>
	
</body>

</html>